<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Poker Replayer</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [기본 스타일] */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212; /* 배경: 다크 모드 */
            color: white;
            margin: 0;
            padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* [1. 입력창 영역] */
        .input-area { width: 100%; max-width: 900px; margin-bottom: 20px; background: #2c2c2c; padding: 15px; border-radius: 10px; box-sizing: border-box; }
        textarea { width: 100%; background: #121212; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; box-sizing: border-box; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
        button:hover { background: #45a049; }

        /* [2. 포커 테이블 디자인] */
        .poker-table {
            width: 100%; max-width: 800px; height: 500px;
            background: radial-gradient(circle, #35654d 0%, #1b3a2b 100%);
            border: 15px solid #3e2723; border-radius: 250px;
            position: relative; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .board-area {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 50px; min-height: 80px; min-width: 200px; display: flex; align-items: center; justify-content: center;
        }

        /* 좌석 배치 */
        .seat { position: absolute; width: 120px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .seat-pos-1 { bottom: 10%; right: 10%; }
        .seat-pos-2 { bottom: 5%; left: 50%; transform: translateX(-50%); }
        .seat-pos-3 { bottom: 10%; left: 10%; }
        .seat-pos-4 { top: 10%; left: 10%; }
        .seat-pos-5 { top: 5%; left: 50%; transform: translateX(-50%); }
        .seat-pos-6 { top: 10%; right: 10%; }

        .player-info { background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 10px; font-size: 12px; margin-top: 5px; border: 1px solid #555; }
        .hero-seat .player-info { background: #2e7d32; border: 2px solid #4caf50; font-weight: bold; }
        .dealer-btn { width: 20px; height: 20px; background: gold; color: black; border-radius: 50%; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid #b8860b; position: absolute; top: -10px; right: -5px; z-index: 10; }
        .poker-card-img { width: 70px; height: auto; border-radius: 3px; box-shadow: 1px 1px 4px rgba(0,0,0,0.5); margin: 2px; }
        .card-back { width: 50px; height: 80px; background: #b71c1c; border: 2px solid white; border-radius: 4px; margin: 2px; background-image: repeating-linear-gradient(45deg, #b71c1c 0, #b71c1c 5px, #c62828 5px, #c62828 10px); }

        /* [3. 하단 액션 타임라인] */
        .action-timeline { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        /* [3. 하단 액션 타임라인 기둥] */
        .street-column {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 10px;
            border-top: 4px solid #444;

            /* 👇 여기가 핵심 수정 사항입니다 */
            height: auto;        /* 기존 300px 삭제 -> 내용만큼 자동으로 길어짐 */
            overflow-y: visible; /* 기존 auto 삭제 -> 스크롤바 없애고 그냥 보여줌 */
            min-height: 200px;   /* 내용이 없어도 최소한의 높이는 유지해서 예쁘게 */
        }
        .street-header { text-align: center; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; color: #aaa; display: flex; justify-content: center; align-items: center; }

        /* 팟 금액 뱃지 💰 */
        .pot-badge { background-color: #333; color: #ffd700; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px; border: 1px solid #555; }

        /* 🏆 승자 뱃지 스타일 */
        .win-badge {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ffd700, #ffecb3, #ffd700); /* 금색 그라데이션 */
            color: #d50000;
            font-weight: 900;
            font-size: 24px;
            padding: 5px 15px;
            border-radius: 50px;
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); /* 금색 빛 */
            z-index: 20;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 펑! 하고 나타나는 효과 */
        }

        /* 승자 카드는 테두리를 금색으로 빛나게 */
        .winner-highlight img {
            box-shadow: 0 0 10px gold !important;
            border: 2px solid gold !important;
        }

        /* 액션 말풍선 (기본 폰트 키움: 13px -> 15px) */
        .action-bubble {
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 15px;
            color: #333;
            font-weight: 600;
            background-color: #ffffff; /* 기본 흰색 */
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }

        /* 2. Hero(나)의 모든 행동 (최우선 적용) -> 노란 배경 + 빨간 글씨 */
        .act-hero {
            background-color: #ffeb3b !important;
            color: #d50000 !important;
            border: 2px solid #fbc02d !important;
            font-size: 16px;
            font-weight: 800;
        }

        /* 3. 남들의 Fold -> 어두운 회색 + 작게 */
        .act-fold {
            background-color: #424242;
            color: #b0b0b0;
            font-size: 12px; /* 약간 작게 */
            padding: 6px 10px;
        }

        /* 4. 남들의 Check/Call -> 연한 회색 */
        .act-check {
            background-color: #e0e0e0;
            color: #333;
        }

    </style>
</head>
<body>

<div class="input-area">
    <form action="/parse" method="post">
        <textarea name="historyText" rows="4" placeholder="여기에 핸드 히스토리를 붙여넣으세요..." th:text="${originalText}"></textarea>

        <div style="margin-top: 10px; display: flex; align-items: center; gap: 15px;">

            <div>
                <input type="checkbox" id="anonCheck" name="isAnonymous" value="true">
                <label for="anonCheck" style="color: #ccc; font-weight: bold; cursor: pointer;">
                    🕵️ 익명 모드
                </label>
            </div>

            <div>
                <input type="checkbox" id="bbCheck" name="isBBMode" value="true">
                <label for="bbCheck" style="color: #ccc; font-weight: bold; cursor: pointer;">
                    🔵 BB 모드 ($ ➔ BB)
                </label>
            </div>
        </div>

        <button type="submit">핸드 분석하기 🎲</button>
    </form>
</div>

<div th:if="${result != null}" style="width: 100%; display: flex; flex-direction: column; align-items: center;">

    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button onclick="downloadImage()" style="background: #0288d1; width: auto;">📸 이미지로 저장</button>
        <button onclick="copyToClipboard()" style="background: #7b1fa2; width: auto;">📋 클립보드 복사</button>
    </div>

    <div id="capture-target" style="background-color: #121212; padding: 20px; border-radius: 10px; width: 100%; max-width: 950px; display: flex; flex-direction: column; align-items: center;">

        <div class="poker-table">
            <div class="board-area">
                <img th:each="card : ${result.boardCards}" th:src="@{/images/cards/__${card.imageName}__}" class="poker-card-img">
            </div>

            <div th:each="player : ${result.players}" class="seat"
                 th:classappend="'seat-pos-' + ${player.seatNumber} + ' ' + (${player.hero} ? 'hero-seat' : '')">

                <div th:if="${player.button}" class="dealer-btn">D</div>
                <div th:if="${player.winner}" class="win-badge">WIN!</div>

                <div style="display: flex; justify-content: center;"
                     th:classappend="${player.winner} ? 'winner-highlight' : ''">
                    <th:block th:if="${not #lists.isEmpty(player.cards)}">
                        <img th:each="card : ${player.cards}" th:src="@{/images/cards/__${card.imageName}__}" class="poker-card-img">
                    </th:block>
                    <th:block th:if="${#lists.isEmpty(player.cards)}">
                        <div class="card-back"></div>
                        <div class="card-back" style="margin-left: -35px;"></div>
                    </th:block>
                </div>

                <div class="player-info">
                    <div th:text="${player.name}">Name</div>
                    <div th:text="${player.stackDisplay}" style="color: #ffd700; font-size: 11px; margin-top: 2px;">$100</div>
                </div>
            </div>
        </div>

        <div class="action-timeline">

            <div class="street-column" style="border-top-color: #90caf9;">
                <div class="street-header">
                    Pre-Flop <span class="pot-badge" th:text="${result.potPreflop}">$0</span>
                </div>
                <div th:each="action : ${result.preflopActions}" th:text="${action}" class="action-bubble"
                     th:classappend="${
                        (result.heroName != null and #strings.startsWith(action, result.heroName + ':')) ? 'act-hero' :
                        (#strings.containsIgnoreCase(action, 'fold') ? 'act-fold' :
                        (#strings.containsIgnoreCase(action, 'check') or #strings.containsIgnoreCase(action, 'call') or #strings.containsIgnoreCase(action, 'posts') ? 'act-check' :
                        ''))
                     }">
                </div>
            </div>

            <div class="street-column" style="border-top-color: #a5d6a7;">
                <div class="street-header">
                    Flop <span class="pot-badge" th:text="${result.potFlop}">$0</span>
                </div>
                <div th:each="action : ${result.flopActions}" th:text="${action}" class="action-bubble"
                     th:classappend="${
                        (result.heroName != null and #strings.startsWith(action, result.heroName + ':')) ? 'act-hero' :
                        (#strings.containsIgnoreCase(action, 'fold') ? 'act-fold' :
                        (#strings.containsIgnoreCase(action, 'check') or #strings.containsIgnoreCase(action, 'call') or #strings.containsIgnoreCase(action, 'posts') ? 'act-check' :
                        ''))
                     }">
                </div>
            </div>

            <div class="street-column" style="border-top-color: #ffcc80;">
                <div class="street-header">
                    Turn <span class="pot-badge" th:text="${result.potTurn}">$0</span>
                </div>
                <div th:each="action : ${result.turnActions}" th:text="${action}" class="action-bubble"
                     th:classappend="${
                        (result.heroName != null and #strings.startsWith(action, result.heroName + ':')) ? 'act-hero' :
                        (#strings.containsIgnoreCase(action, 'fold') ? 'act-fold' :
                        (#strings.containsIgnoreCase(action, 'check') or #strings.containsIgnoreCase(action, 'call') or #strings.containsIgnoreCase(action, 'posts') ? 'act-check' :
                        ''))
                     }">
                </div>
            </div>

            <div class="street-column" style="border-top-color: #ef9a9a;">
                <div class="street-header">
                    River <span class="pot-badge" th:text="${result.potRiver}">$0</span>
                </div>
                <div th:each="action : ${result.riverActions}" th:text="${action}" class="action-bubble"
                     th:classappend="${
                        (result.heroName != null and #strings.startsWith(action, result.heroName + ':')) ? 'act-hero' :
                        (#strings.containsIgnoreCase(action, 'fold') ? 'act-fold' :
                        (#strings.containsIgnoreCase(action, 'check') or #strings.containsIgnoreCase(action, 'call') or #strings.containsIgnoreCase(action, 'posts') ? 'act-check' :
                        ''))
                     }">
                </div>
            </div>

        </div>

    </div> </div>

<script>
    function downloadImage() {
        const target = document.getElementById("capture-target");
        html2canvas(target, { backgroundColor: "#121212", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'poker-hand.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function copyToClipboard() {
        const target = document.getElementById("capture-target");
        html2canvas(target, { backgroundColor: "#121212", scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
                try {
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(() => {
                        alert("클립보드에 복사되었습니다! 📋");
                    });
                } catch (err) {
                    alert("이 브라우저에서는 지원하지 않습니다.");
                }
            });
        });
    }
</script>

</body>
</html>